# Телеграм-бот для VPN сервиса

## Описание проекта

Telegram-бот для управления VPN-сервисом с функциями:
- Регистрация пользователей
- Покупка и управление подписками
- Автоматическое продление подписок
- Оплата через YooKassa и Telegram Payments
- Генерация QR-кодов для настройки VPN
- Система часто задаваемых вопросов (FAQ)
- Реферальная программа
- Административная панель для управления пользователями и подписками

## Технологический стек

- Node.js и TypeScript
- Express.js для API и административной панели
- PostgreSQL и Prisma ORM для работы с базой данных
- Docker и Docker Compose для контейнеризации
- QR-код генерация для удобной настройки VPN

## Запуск проекта

### Предварительные требования

- Docker и Docker Compose
- Node.js v16 или выше
- PostgreSQL

### Настройка окружения

1. Скопируйте `.env.example` в `.env` и настройте переменные окружения:
   ```
   cp .env.example .env
   ```

2. Настройте подключение к базе данных в `.env`:
   ```
   DATABASE_URL="postgresql://postgres:postgrespassword@localhost:5432/vpn_bot?schema=public"
   ```

3. Настройте Telegram Bot Token:
   ```
   TELEGRAM_BOT_TOKEN=your_bot_token
   ADMIN_CHAT_ID=your_admin_chat_id
   ```

4. Настройте API ключи для платежных систем:
   ```
   YOOKASSA_SHOP_ID=your_shop_id
   YOOKASSA_SECRET_KEY=your_secret_key
   ```

5. При необходимости включите Telegram Payments:
   ```
   ENABLE_TELEGRAM_PAYMENTS=true
   TELEGRAM_PAYMENT_TOKEN=your_payment_token
   ```

### Платежные методы

Бот поддерживает несколько способов оплаты:

1. **Банковская карта** - стандартная оплата через ЮKassa с перенаправлением пользователя на страницу оплаты
2. **ЮKassa в Telegram** - интеграция ЮKassa внутри Telegram, как описано в [документации ЮKassa](https://yookassa.ru/docs/support/payments/onboarding/integration/cms-module/telegram)
3. **Telegram Payments** - нативный метод оплаты в Telegram (требуется подключение через BotFather)

Чтобы включить необходимые методы оплаты, настройте соответствующие параметры в файле `.env`.

### Запуск с помощью Docker

1. Соберите и запустите контейнеры:
   ```
   docker compose up -d
   ```

2. Инициализируйте базу данных (при первом запуске):
   ```
   docker exec -it vpn-bot-app npx prisma migrate deploy
   ```

3. Опционально: заполните базу данных начальными данными:
   ```
   docker exec -it vpn-bot-app npm run prisma:seed
   ```

### Запуск локально (для разработки)

1. Установите зависимости:
   ```
   npm install
   ```

2. Компилируйте TypeScript:
   ```
   npm run build
   ```

3. Запустите миграции базы данных:
   ```
   npm run prisma:migrate
   ```

4. Запустите приложение:
   ```
   npm start
   ```

## Функциональность и решение проблем

### 1. Проблемы с фоновыми задачами

Если возникают ошибки с фоновыми задачами (автопродление, напоминания, обновление статусов), проверьте:
- Корректность подключения к базе данных
- Наличие необходимых таблиц в базе данных
- Правильное форматирование переменных окружения в `.env` файле

Для отключения фоновых задач временно:
1. Отредактируйте файл `dist/index.js`
2. Замените функцию `setupBackgroundTasks` на:
   ```js
   function setupBackgroundTasks() { 
     logger.info('Настройка фоновых задач...'); 
     logger.info('Фоновые задачи отключены для отладки'); 
   }
   ```

### 2. Настройка QR-кодов для VPN-конфигурации

Для корректной работы QR-кодов:
- Убедитесь, что переменная `QR_CODE_SIZE` установлена в `.env`
- Проверьте доступность директории для сохранения временных QR-кодов

### 3. Настройка автопродления

Для включения автопродления подписок:
- Установите `ENABLE_AUTO_RENEWAL=true` в `.env`
- Настройте дни для отправки напоминаний: `REMINDER_DAYS=7,3,1`
- Для YooKassa автопродления укажите ID метода оплаты: `YOOKASSA_AUTO_PAYMENT_METHOD_ID=your_method_id`

## Административная панель

Административная панель доступна по адресу: `http://your_server:3000/admin`

В панели администратора доступны следующие функции:
- Управление пользователями
- Управление подписками
- Просмотр истории платежей
- Управление FAQ
- Настройки сервера

## API Документация

REST API доступен по базовому URL: `http://your_server:3000/api`

Основные эндпоинты:
- `/api/users` - управление пользователями
- `/api/subscriptions` - управление подписками
- `/api/payments` - управление платежами
- `/api/faq` - управление FAQ

## Логирование и отладка

Логи приложения сохраняются в директории `logs/`.

Для более подробного логирования измените уровень логирования в `.env`:
```
LOG_LEVEL=debug
```

## Лицензия

Проект распространяется под MIT лицензией. 